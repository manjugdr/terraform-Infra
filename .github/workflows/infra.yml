name: Terraform Workflow

on:
  workflow_dispatch:
    inputs:
      module:
        description: "Select the Terraform module to run (e.g., ec2, vpc, rds, eks, ecr)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - ec2
          - vpc
          - rds
          - eks
          - ecr
      action:
        description: "Select the Terraform action (plan, apply, destroy)"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: "Select the environment (dev, prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7 # Specify the Terraform version

      # Initialize Terraform
      - name: Terraform Init
        run: |
          cd environments/${{ github.event.inputs.environment }}
          terraform init

      # Run Terraform Commands
      - name: Terraform ${GITHUB_EVENT_INPUTS_ACTION}
        run: |
          cd environments/${{ github.event.inputs.environment }}
          
          if [ "${{ github.event.inputs.module }}" == "all" ]; then
            terraform ${GITHUB_EVENT_INPUTS_ACTION} -auto-approve
          else
            terraform ${GITHUB_EVENT_INPUTS_ACTION} -target=module.${{ github.event.inputs.module }} -auto-approve
          fi
        env:
          TF_VAR_environment: ${{ github.event.inputs.environment }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
